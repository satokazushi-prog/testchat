<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini „ÉÅ„É£„ÉÉ„Éà</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: Helvetica, Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background: #e5ddd5;
        }
        .header {
            flex-shrink: 0;
            padding: 12px 16px;
            background: #075e54;
            color: #fff;
            font-size: 18px;
            font-weight: 600;
        }
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px 80px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .bubble {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 18px;
            line-height: 1.5;
            word-break: break-word;
            font-size: 15px;
        }
        .bubble.user {
            align-self: flex-end;
            background: #dcf8c6;
            color: #000;
            border-bottom-right-radius: 4px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.08);
        }
        .bubble.ai {
            align-self: flex-start;
            background: #fff;
            color: #000;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.08);
        }
        .bubble.error {
            align-self: center;
            background: #ffebee;
            color: #c62828;
            border-radius: 18px;
            font-size: 14px;
        }
        .bubble.loading {
            align-self: flex-start;
            background: #fff;
            color: #888;
            font-style: italic;
        }
        .input-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 8px;
            padding: 10px 12px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            background: #f0f0f0;
            border-top: 1px solid #ddd;
        }
        .input-bar input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 24px;
            font-size: 16px;
            font-family: inherit;
            background: #fff;
            outline: none;
        }
        .input-bar input:focus {
            box-shadow: 0 0 0 2px #075e54;
        }
        .input-bar button {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background: #075e54;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .input-bar button:hover:not(:disabled) {
            background: #054d44;
        }
        .input-bar button:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
        }
        .input-bar .file-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .input-bar input[type="file"] {
            display: none;
        }
        .input-bar .file-btn {
            flex-shrink: 0;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #075e54;
            background: #fff;
            color: #075e54;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
        }
        .input-bar .file-btn:hover {
            background: #e8f5e9;
        }
        .input-bar .file-name {
            font-size: 12px;
            color: #666;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <header class="header">Gemini „ÉÅ„É£„ÉÉ„Éà</header>

    <main class="chat-area" id="chatArea"></main>

    <div class="input-bar">
        <div class="file-wrap">
            <input type="file" id="imageInput" accept="image/*">
            <button type="button" class="file-btn" id="fileBtn" title="ÁîªÂÉè„ÇíÈÅ∏Êäû">üì∑ ÁîªÂÉè</button>
            <span class="file-name" id="fileName" aria-live="polite"></span>
        </div>
        <input type="text" id="message" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ" autocomplete="off">
        <button type="button" id="send" title="ÈÄÅ‰ø°">‚û§</button>
    </div>

    <script>
        const chatArea = document.getElementById("chatArea");
        const input = document.getElementById("message");
        const sendBtn = document.getElementById("send");
        const imageInput = document.getElementById("imageInput");
        const fileBtn = document.getElementById("fileBtn");
        const fileNameEl = document.getElementById("fileName");

        fileBtn.addEventListener("click", () => imageInput.click());
        imageInput.addEventListener("change", () => {
            const file = imageInput.files[0];
            fileNameEl.textContent = file ? file.name : "";
        });

        function addBubble(text, type) {
            const div = document.createElement("div");
            div.className = "bubble " + type;
            div.textContent = text;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
            return div;
        }

        function removeBubble(el) {
            if (el && el.parentNode) el.parentNode.removeChild(el);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const dataUrl = reader.result;
                    const base64 = dataUrl.indexOf(",") >= 0 ? dataUrl.split(",")[1] : dataUrl;
                    resolve(base64);
                };
                reader.onerror = () => reject(reader.error);
                reader.readAsDataURL(file);
            });
        }

        async function sendMessage() {
            const message = input.value.trim();
            const file = imageInput.files[0];
            if (!message && !file) return;

            const displayText = message || (file ? "ÁîªÂÉè„ÇíÈÄÅ‰ø°" : "");
            if (displayText) addBubble(displayText, "user");
            if (file) addBubble("üì∑ " + file.name, "user");
            input.value = "";
            imageInput.value = "";
            fileNameEl.textContent = "";

            const loadingEl = addBubble("ËÄÉ„Åà‰∏≠...", "loading");
            sendBtn.disabled = true;

            let imageBase64 = null;
            if (file) {
                try {
                    imageBase64 = await fileToBase64(file);
                } catch (e) {
                    removeBubble(loadingEl);
                    addBubble("„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü", "error");
                    sendBtn.disabled = false;
                    return;
                }
            }

            try {
                const body = { message: message || "" };
                body.image = imageBase64 != null ? imageBase64 : null;

                const res = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body),
                    credentials: "include"
                });
                const data = await res.json().catch(() => ({}));

                removeBubble(loadingEl);

                if (!res.ok) {
                    addBubble(data.response || "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü", "error");
                    return;
                }
                addBubble(data.response || "", "ai");
            } catch (e) {
                removeBubble(loadingEl);
                addBubble("„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü", "error");
            } finally {
                sendBtn.disabled = false;
                input.focus();
            }
        }

        sendBtn.addEventListener("click", sendMessage);
        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
